name: deploy
on:
  workflow_dispatch:
    inputs:
      environment:
          description: 'Target environment'
          required: true
          default: 'sandbox'
          type: choice
          options:
            - sandbox

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: Write Key File
        run: echo "${{ secrets.SF_JWT_KEY }}" > server.key

      - name: Authenticate with JWT
        run: |
          sf org login jwt \
            --client-id ${{ secrets.SF_CLIENT_ID }} \
            --jwt-key-file ./server.key \
            --username ${{ secrets.SF_USERNAME }} \
            --alias ${{ secrets.SF_ORG }} \
            --instance-url ${{ secrets.SF_INSTANCE_URL }}

      - name: Deploy source to org
        run: |
          sf project deploy start --manifest force-app/manifest/package.xml --target-org ${{ secrets.SF_ORG }} --ignore-conflicts